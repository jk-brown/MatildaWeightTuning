---
title: "Computing Summary statistic and error terms"
author: "Joe Brown"
date: "2024-09-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal

First computing summary statistics for the temperature metrics and then using IPCC values to compute error terms for each criteria weight combination.

*Note: IPCC values referenced here are stored in the setup.R file* 

# Compute summary statistics

Use `split_data_frame` to compute summary statistics (weighted median and percentiles) for temperature metrics from each SSP scenario. 

```{r}
stat_summary <- lapply(scenario_metrics, function(df) {
  
  split_data <- split_data_frame(df)
  
  data_summary_test(split_data)

})
```

## Compute error terms

Needs notes and documentation.

```{r}
error_results <- lapply(names(stat_summary), function(scenario_name) {
  
  scenario <- stat_summary[[scenario_name]]  # Get metric stats for the scenario
  
  # Process each criteria influence
  error_by_criteria_id <- lapply(names(scenario), function(criteria_id) {
    metric_stats <- scenario[[criteria_id]]  # Get the data frame for the criteria
    
    # Retrieve corresponding IPCC values for the 'long' timescale for this scenario
    ipcc_values_for_scenario <- ipcc_values[[scenario_name]]
    ipcc_median <- ipcc_values_for_scenario[1]
    ipcc_lower  <- ipcc_values_for_scenario[2]
    ipcc_upper  <- ipcc_values_for_scenario[3]
    
    # Calculate the errors for each statistic (median, lower, upper)
    median_error <- compute_error(metric_stats$median, ipcc_median)
    lower_error  <- compute_error(metric_stats$lower, ipcc_lower)
    upper_error  <- compute_error(metric_stats$upper, ipcc_upper)
    
    # compute error for current criteria weight combo
    median_error = median_error
    lower_error  = lower_error
    upper_error  = upper_error
      
    # Return error results as a data frame with error
    data.frame(
      criteria_id, 
      median_error = median_error,
      lower_error = lower_error, 
      upper_error = upper_error
    )
  })
  
  # criteria list for each scenario
  bind_error <- do.call(rbind, error_by_criteria_id) 

  # return
  return(bind_error)
  
})

# Set top level names of list to match IPCC naming
names(error_results) <- ssp_names

```

## Putting things together

Where I am at now is needing to put thins together. Ideally I think the best way is a data frame with the following column:

1. `scenario` - name of the SSP scenario.
2. `temp_wt` - the weight values given to observed temperature criterion. 
3. `co2_wt` - the weight values given to observed co2 criterion.
4. `ocean_uptake_wt` - the weight values given to observed ocean C uptake criterion.
5. `metric_stat_values` - the median, lower, and upper bounds from the Hector simulations. Nested in stat_summary (not sure how immediately critical these values are - don't think they are needed for ternary plot).
6. `absolute_error` - the absolute error between the metric estimates from Hector/Matilda and IPCC values. Should be one for each criterion weight combination.
7. `percentage_erro` - represents the percent error rather than absolute error.

Where are these pieces of data currently?:

1. `scenario` - in ssp_names
2. `temp_wt` - in `criteria_weights` 
3. `co2_wt` - in `criteria_weights` 
4. `ocean_uptake_wt` - in `criteria_weights` 
5. `metric_stat_values` - skipping this for now -- will need it for another figure later.
6. `absolute_error` - in `error_results`
7. `percentage_error` - in `error_results`


```{r}
# building data frame for plotting 

# scratch data frame with SSP scenarios, repeating for the know number of criteria combinations (total rows = 219 x 5) 
scenario_df <- data.frame(scenario = rep(ssp_names, each = 219))

# Binding together all criterion weights and repeating for each scenario (total rows 1095)
bind_criteria_weights <- do.call(rbind, criteria_weights)
criteria_weights_df <- bind_criteria_weights[rep(1:nrow(bind_criteria_weights), times = 5), ]

# Binding together error results for each scenario (total rows 1095)
bind_error_results <- do.call(rbind, error_results)

# combining columns for plotting 
plot_df <- cbind(scenario_df, criteria_weights_df, bind_error_results)

```

Save plotting data:
```{r}
# save plot data 
saveRDS(plot_df, "data/plot_data.rds")
```

